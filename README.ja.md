[中文(中国)](README.md) [English](README.en.md)
[English](README.en.md) [日本語](README.ja.md)

# BiliBili コメント/動画ダウンロードソフトウェア
- [BiliBili コメント/動画ダウンロードソフトウェア](#BiliBili コメント/動画ダウンロードソフトウェア)
    * [紹介](#紹介)
    * [プログラム機能](#プログラム機能)
    * [依存ライブラリ](#依存ライブラリ)
        + [JavaScript依存ライブラリ](#javascript依存ライブラリ)
    * [ファイル構成](#ファイル構成)
        + [cookies.json](#cookiesjson)
        + [settings.json](#settingsjson)
        + [webui.json](#webuijson)
        + [sections.json](#sectionsjson)
        + [tv.bilibili.player.xml](#tvbilibiliplayerxml)
    * [はじめに](#はじめに)
        + [prepare.py](#preparepy)
        + [コメントのフィルタリング](#コメントのフィルタリング)
    * [翻訳](#翻訳)
    * [その他](#その他)
        + [全コメントのダウンロード問題](#全コメントのダウンロード問題)
    * [FAQ](#faq)
        + [リリースにおける各ドキュメントの違い](#リリースにおける各ドキュメントの違い)
        + [パスワードを入力できない](#パスワードを入力できない)
        + [大会員のアカウントは、大会員しか見られないことを示唆している](#大会員のアカウントは、大会員しか見られないことを示唆している)
        + [デフォルトのダウンロード場所はどこですか？](#デフォルトのダウンロード場所はどこですか？)
        + [ffmpeg, aria2cを使用するべきかどうか](#ffmpeg, aria2cを使用するべきかどうか)
        + [一括ダウンロードする方法](#一括ダウンロードする方法)
        + [クラッシュした場合の対処方法](#クラッシュした場合の対処方法)
        + [aria2cのいくつかのダウンロード設定は何を意味しますか？](#aria2cのいくつかのダウンロード設定は何を意味しますか？)
## 紹介
このプログラムはPython(Python 3.x)言語で書かれており、いくつかのPythonライラリとChromeDriverを使用しています(ChromeDriverを持っているとログインやキャプチャ認証が簡単になります。またメインプログラムには影響しません)。
コマンドライン(Command Line)に対応  
リリース ビルドスクリプトは[bili.build.bat](https://github.com/lifegpc/bili.build.bat)にあります。
## プログラム機能
- [x] [aria2cを使用したダウンロード](#aria2cを使用したダウンロード)
- [x] [分割された動画の自動マージ](#分割された動画の自動マージ)
- [x] [mp4およびmkv形式](#mp4およびmkv形式)
- [x] [m4a形式](#m4a形式)
- [x] [flac形式](#flac形式)
- [ ] [mp3形式](#mp3形式)
- [x] [一般No.AV/BV](#一般No.AV/BV)
    * [x] コメントダウンロード
    * [x] 全コメント(コメント履歴)ダウンロード
    * [x] ビデオダウンロード
    * [x] [オーディオのみダウンロード](#オーディオのみダウンロード)
    * [x] カバーイメージ(サムネイル)のみダウンロード
    * [x] 字幕のみダウンロード
    * [x] 4KとHDR
    * [x] インタラクティブなビデオ
- [x] [番組](#番組)
    * [x] コメントダウンロード
    * [x] 全コメント(コメント履歴)ダウンロード
    * [x] ビデオダウンロード
    * [x] [オーディオのみダウンロード](#オーディオのみダウンロード-1)
    * [x] [カバーイメージ(サムネイル)のみダウンロード](#カバーイメージ(サムネイル)のみダウンロード)
    * [x] 4K
    * [ ] HDR(サポート可能、現時点でのテスト可能な動画はありません)
- [x] [有料コンテンツ](#有料コンテンツ)
    * 与[番組](#番組)とほぼ同じ
    * [カバーイメージ(サムネイル)のみダウンロード](#カバーイメージ(サムネイル)のみダウンロード-1)
- [x] [有料コンテンツ一覧](#有料コンテンツ一覧)
- [x] [お気に入り](#お気に入り)
    * [サポートしているGETパラメーター](#サポートしているGETパラメーター)
- [x] [チャンネル一覧](#チャンネル一覧)
- [x] [チャンネル](#チャンネル)
    * [サポートしているGETパラメーター](#サポートしているGETパラメーター-1)
- [x] [投稿動画一覧](#投稿動画一覧)
    * [サポートしているGETパラメーター](#サポートしているGETパラメーター-2)
- [x] [ライブ映像](#ライブ映像)
    * [x] [ビデオダウンロード](#ビデオダウンロード)
    * [x] [コメントダウンロード](#コメントダウンロード)
- [x] [ライブストリーミング](#ライブストリーミング)
    * [x] [ビデオダウンロード](#ビデオダウンロード-1)
- [x] [No.AUオーディオ](#No.AUオーディオ)
    * [x] [オーディオダウンロード](#オーディオダウンロード)
    * [x] [歌詞のみダウンロード](#歌詞のみダウンロード)
    * [x] カバーイメージ(サムネイル)のみダウンロード
- [x] [プレイリスト](#プレイリスト)
### aria2cを使用したダウンロード
このプログラムはaria2cを使用してのダウンロードをサポートしており、より良いダウンロード体験のためにaria2cを使用することをお勧めします。
この機能を有効にするには、コマンドライン(通常はプログラムディレクトリから直接aria2cを呼び出すことが可能)から設定でaria2cの使用を有効にしていることを確認する必要があります。
### 分割された動画の自動マージ
このプログラムは分割されたビデオを自動マージするためにffmpegを使用しています。
この機能を有効にするには、コマンドラインから直接ffmpegを呼び出せるようにする必要があります(一般的にはプログラムディレクトリに置くだけ)、設定でffmpegが無効になっていないことを確認する必要があります。
### mp4およびmkv形式
このプログラムは、mp4ファイルまたはmkvファイルへの結合をサポートし、設定でビデオフォーマットを選択することができます。
### m4a形式
このプログラムは、m4aファイルとしてオーディオファイルの直接ダウンロードをサポートしています。
### flac形式
音声の一部にはロスレスの音質が含まれており、flacファイルとして保存することができます。
### mp3形式
このプログラムは現在、mp3形式をサポートしていません（トランスコードしたくないから）
### 一般No.AV/BVビデオ
このプログラムでは、以下の入力に対応しています（例としてAV9、大文字小文字は無視）：
- ```9```
- ```av9```
- ```BV1xx411c7mC```
- ```bilibili.com/video/av9``` （URLのhttps:\\, wwwとかは入力しなくても大丈夫）
- ```bilibili.com/video/BV1xx411c7mC```
- ```b23.tv/av9```
- ```b23.tv/BV1xx411c7mC```
- ```bilibili.com/s/video/av9```
- ```bilibili.com/s/video/BV1xx411c7mC```

動画が[番組](#番組)を指しているのであれば、自動的に番組にリダイレクトされます。
#### オーディオのみダウンロード
現在、DASHストリームの解析結果のみがサポートされています（現時点ではDASHではない解析結果はほとんどありません）
### 番組
このプログラムでは、以下の入力をサポートしています（例としてSS26291、大文字小文字は無視）：
- ```ss26291```
- ```ep259653```
- ```md4316442```
- ```bilibili.com/bangumi/play/ss26291```
- ```bilibili.com/bangumi/play/ep259653```
- ```bilibili.com/bangumi/media/md4316442```
- ```b23.tv/ss26291```
- ```b23.tv/ep259653```
- ```40240711```などNo.AV/BVビデオ

既存のSS番号またはEP番号に基づいてコンテンツが見つからない場合は、同じSS番号およびEP番号を使用して[有料コンテンツ](#有料コンテンツ)へのアクセスを試みます。
#### オーディオのみダウンロード
現在、DASHストリームの解析結果のみがサポートされています
#### カバーイメージ(サムネイル)のみダウンロード
現在開催中のセッションの表紙をダウンロードすると、番組全体のカバーイメージ(サムネイル)が自動的にダウンロードされます。
### 有料コンテンツ
このプログラムでは、以下の入力に対応しています(例としてSS150、大文字小文字は無視)：
- ```bilibili.com/cheese/play/ss150```
- ```bilibili.com/cheese/play/ep2425```
#### カバーイメージ(サムネイル)のみダウンロード
現在のセッションの表紙ではなく、全講座の表紙だけでなく、紹介画像もダウンロードされます。
### 有料コンテンツ一覧
このプログラムは以下の入力をサポートしています：
- ```bilibili.com/cheese/mine/list```
- ```bilibili.com/v/cheese/mine/list```

購入したすべてのコースは、ダウンロードする必要があるものを選択するために解析されます。
### お気に入り
このプログラムは以下の入力をサポートしています(UID1を例にしています)：
- ```space.bilibili.com/1/favlist```

会将所有收藏夹内的视频解析出来以供选择需要下载的视频。
#### サポートしているGETパラメーター
- ```fid```：どのお気に入りかを指定するために使用します
- ```keyword```：お気に入り検索に使用
- ```type```：すべてのお気に入りを検索するか、現在のお気に入りを検索するかを指定します。
- ```tid```：どのパーティションを指定するかに使用され、すべてのパーティションが0になり、--ltidコマンドラインパラメータを使用すると、現在のお気に入りのすべての利用可能なtidを取得できます。
- ```order```：ソートする投稿動画のリストを指定します。```mtime```最近のお気に入り，```view```最も再生された動画，```pubtime```最新の投稿。
### チャンネル一覧
このプログラムは以下の入力をサポートしています(UID1を例にしています)：
- ```space.bilibili.com/1/channel/index```

UP主のすべてのチャンネルを解析して、ダウンロードするチャンネルを選択します。
### チャンネル
このプログラムは以下の入力をサポートしています(UID928123を例にしています)：
- ```space.bilibili.com/928123/channel/detail?cid=42271```
#### サポートしているGETパラメーター
- ```cid```：どのチャンネルかを示すために使用されます(パースするにはcidが必要です)
- ```order```：指明视频排序顺序，0为默认排序，1为倒序排序。

ダウンロードする必要があるものを選択するチャンネルのすべてのビデオを解析します。
### 投稿動画一覧
このプログラムは以下の入力をサポートしています(UID1を例にしています)：
- ```space.bilibili.com/1/video```
- ```bilibili.com/medialist/play/225910184```
#### サポートしているGETパラメーター
- ```tid```：用来指明视频类型，全部是0。可以使用```--ltid```命令行参数来获得当前UP主的投稿视频所有可用的tid。
- ```keyword```：投稿された動画のリストを検索するために使用される。
- ```order```： pubdateは最新のリリース、clickは最も再生された動画、stowは最もお気に入りの動画のリストの順番を指定します。

ダウンロードが必要なチャンネルのために、UP主が投稿した動画をすべて解析します。
### ライブ映像
このプログラムは以下の入力をサポートしています(R1mx411c7Enを例にしています)：
- ```live.bilibili.com/record/R1mx411c7En```
#### ビデオダウンロード
この時点ではオリジナルの画像のみがダウンロードに対応しているため、他の画質が表示された場合はダウンローダーが表示する必要があります
動画のリンク先を[issues](https://github.com/lifegpc/bili/issues)に投稿してください。
#### コメントダウンロード
現在は通常のコメントのみ対応しており、プレゼント(ギフト)などは対応していません
コメントは元の形式からXML形式に変換されます。
### ライブストリーミング
このプログラムは以下の入力をサポートしています(例として、部屋番号1)：
- ```live.bilibili.com/1```
#### ビデオダウンロード
複数の画質オプションをサポートしています
メインラインとバックアップラインの選択をサポートしています(コマンドラインが必要)。
### No. AUオーディオ
このプログラムは以下の入力をサポートしています(AU1を例にしています)：
- ```au1```
- ```bilibili.com/audio/au1```
- ```b23.tv/au1```
#### オーディオダウンロード
複数の音質に対応したので、使って楽しんでください
オーディオに通常のビデオが関連付けられている場合、関連するビデオページからより多くのオーディオ品質を取得するための試みが行われます。
#### 歌詞のみダウンロード
デフォルトでは、プログラムはダウンロードした歌詞ファイルをフィルタリングして、より多くのプレイヤーにフィットするようにそれらを修正します
オーディオに通常の動画が関連付けられている場合、関連する動画ページからより多くの歌詞(つまり字幕)を取得しようとします。
### プレイリスト
このプログラムは以下の入力をサポートしています（以AM29931432为例）：
- ```am29931432```
- ```bilibili.com/audio/am29931432```
- ```bilibili.com/audio/mycollection/29981833```
## 依存ライブラリ
[requests](https://pypi.org/project/requests/)   
[selenium](https://pypi.org/project/selenium/)  
[rsa](https://pypi.org/project/rsa/)  
[polib](https://pypi.org/project/polib/)  
[web.py](https://webpy.org/)  
[regex](https://pypi.org/project/regex/)  
[iso-639](https://pypi.org/project/iso-639/)  
[pywin32](https://pypi.org/project/pywin32/)  
用户名密码登录部分参考了[Bilibili-Toolkit](https://github.com/Hsury/Bilibili-Toolkit)的登录部分代码。
### JavaScript依存ライブラリ
[jQuery](https://jquery.com/)  
[js-sha256](https://github.com/emn178/js-sha256)  
[jsbn](http://www-cs-students.stanford.edu/~tjw/jsbn/)（注：已被合并到[```webuihtml/js(origin)/rsa.js```](webuihtml/js(origin)/rsa.js)）  
[js-base64](https://github.com/dankogai/js-base64)  
[QRCode.js](https://github.com/davidshimjs/qrcodejs)  
[Viewer.js](https://github.com/fengyuanchen/viewerjs)  
[clipboard.js](https://github.com/zenorocha/clipboard.js)  
[FileSaver.js](https://github.com/eligrey/FileSaver.js)
## ファイル構成
### cookies.json
该文件保存了登录B站后获取到的cookies信息，用于程序保持登录B站（调用历史弹幕接口用以及下载720P及以上视频使用）   

### settings.json
该文件保存了一些设置，可以运行**setsettings.py**来设置。

### webui.json
保存了WEB用户界面的设置。

### sections.json
当WEB用户界面打开密码验证时，存储会话信息。

### tv.bilibili.player.xml
该文件包括弹幕过滤规则。
可以直接将在PC网页端播放器的弹幕过滤设定中导出的文件放至程序目录下，并确保文件名为**tv.bilibili.player.xml**。

## はじめに
直接运行start.py即可

### prepare.py
运行后可以取得运行WEB用户界面必须的一些文件。  
运行时确保可以直接访问```java```。  
~~由于死🐴的Cloudflare的防BOT检测，现在已经无法自动更新/下载```compiler.jar```，请去[这里](https://mvnrepository.com/artifact/com.google.javascript/closure-compiler/latest)下载```compiler.jar```，没有该文件将无法进行编译。~~（貌似目前没有防BOT检测）

### WEBユーザーインターフェース
运行**startwebui.py**后，可以在浏览器访问。  
默认地址为```http://localhost:8080```。

### コメントのフィルタリング
运行filter.py即可   
注意：必须要有**tv.bilibili.player.xml**文件才能进行弹幕过滤。

## 翻訳
你可以在[Transifex](https://www.transifex.com/lifegpc/bili/)上为该程序提供翻译。  
感谢Kum4423提供日语翻译。

## その他
完美支持**普通视频**的弹幕下载   
现已支持**SS号（番剧）**的普通弹幕和全弹幕下载，但全弹幕下载**开始时间**[可能](#b)需要**手动调整**（目前暂未发现每1P的具体时间戳）   
**全弹幕下载建议使用自动模式，不建议自己输入间隔天数**   
<a name='b'></a>注：第1P一般是准确的。

### 全コメントのダウンロード問題
由于B站限制了历史弹幕的调用次数，大概12h内可以调用1000次左右，所以在弹幕较多的时候请设定较大的时间间隔。   
被限制后大约12h后会恢复正常

## FAQ

### リリースにおける各ドキュメントの違い
- ```bili_版本.7z``` 最简单的版本，需要自己下载/安装aria2c, chromedriver, ffmpeg, Python3.6+
- ```bili_版本_linux.7z``` 最简单的版本加上Linux版的chromedriver
- ```bili_版本_mac.7z``` 最简单的版本加上Mac版的chromedriver
- ```bili_版本_windows.7z``` 最简单的版本加上Windows版的chromedriver
- ```bili_版本_windows10_x64.7z``` 编译成exe的版本，可以直接在64位Windows10上运行。自带aria2c, chromedriver, ffmpeg
- ```bili_版本_windows10_x64.exe``` ```bili_版本_windows10_x64.7z```的安装包版本
- ```bili_版本_windows_x64.7z``` 自带Python3.8.6, aria2c, chromedriver, ffmpeg，双击bat文件即可直接在windows7及以上的64位系统中运行
- ```bili_版本_windows_x64.exe``` ```bili_版本_windows_x64.7z```的安装包版本
- ```bili_版本_windows_x86.7z``` 自带Python3.8.6, aria2c, chromedriver, ffmpeg，双击bat文件即可直接在windows7及以上的32位系统中运行
- ```bili_版本_windows_x86.exe``` ```bili_版本_windows_x86.7z```的安装包版本

建议选择后4个版本。

### パスワードを入力できない
这是由于输入密码时关闭了输入内容在屏幕上输出（回显）导致的。  
解决方法是直接正常输入密码后按回车键即可。

### 大会員のアカウントは、大会員しか見られないことを示唆している
先删除```cookies.json```，然后使用Chrome Driver登录，不要使用WEB UI登录。（WEB UI登录目前存在BUG）

### デフォルトのダウンロード場所はどこですか？
默认下载位置在程序所在目录下的```Download```文件夹。  
如果使用安装包安装的话，程序所在目录默认在```%appdata%/bili```或```%appdata%/bili x86```或```%appdata%/bili x64```。

### ffmpeg, aria2cを使用するべきかどうか
建议都使用。  
ffmpeg是用来自动合并分离的视频的。  
aria2c可以极大地改善下载的体验。

### 一括ダウンロードする方法
目前可以使用,隔开多个输入，也可以采用收藏夹等方式批量下载。  
批量下载时建议配合命令行使用。（命令行的基础知识请自己搜索）  
例如每次都选择下载方法4，可以使用```py start.py -d4```。  
更多的命令行指令可以采用```py start.py -h```查看。

### クラッシュした場合の対処方法
目前除了windows_x64和windows_x86的batch脚本外，另外的版本都会在运行完毕后直接退出（无论程序是否出现错误）。  
如果是主程序，可以在设置里启用写入日志到文件，然后去程序所在目录下的```log```文件夹寻找日志。如果出现错误，你可以在最后面看到错误的具体信息。

### aria2cのいくつかのダウンロード設定は何を意味しますか？
aria2c是一个多线程下载工具。  
多线程下载简单理解就是把1个文件分成n部分，每一部分同时下载。  
同时下载的部分数越多，一般速度也就越快。  
有关aria2c的设置：  
是否启用aria2c：建议是，使用aria2c可以提供更好的下载体验（下载速度快）  
使用aria2c时单个服务器最大连接数和单个文件最大连接数：这两者共同来限制最多能有多少部分能够同时下载。因此调大这两者可以增加同时下载的部分数，从而使速度加快。  
使用aria2c时文件分片大小：aria2c是根据文件分片大小来将1个文件分成n部分。假设有1个100M的文件，文件分片大小是20M，因此这个文件将会被分成5部分。当文件大小不足文件分片大小的2倍时，这个文件将不会被分成n部分，而是当作一个整体下载。调小这个可以时文件被分成的部分数加多，一定程度上可以加快速度。  
注：如果出现0b/s的情况，说明暂时被BiliBili CDN封禁，请适当调整上述参数以降低同时下载的部分数。  
在使用aria2c下载时使用备用网址：建议开着，这样可以同时从多个CDN服务器下载内容，加快下载速度。  
使用aria2c下载时文件预分配方式：这个一般建议保持默认值。  
在使用aria2c时最大总体速度(B/s)：这个根据个人需求设置吧。
